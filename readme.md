# Go Pickup Point API

## Запуск через docker
```bash
docker-compose up -d
```
или
```bash
docker compose up -d
```

## Обзор
**Go Pickup Point API** - это бэкенд-сервис, разработанный для управления пунктами выдачи заказов (ПВЗ), приемок товаров и отслеживания инвентаря. Этот сервис позволяет сотрудникам пунктов выдачи обрабатывать входящие заказы, управлять приемкой товаров и отслеживать инвентарь в разных местах. Система включает контроль доступа на основе ролей с различными разрешениями для модераторов и сотрудников ПВЗ.

## Функциональность
- Аутентификация и авторизация пользователей 
  - Аутентификация на основе JWT 
  - Контроль доступа на основе ролей (employee и moderator)
  - Регистрация и вход пользователей
- Управление пунктами выдачи заказов 
  - Создание и вывод списка пунктов выдачи 
  - Поддержка нескольких городов (Москва, Санкт-Петербург, Казань)
  - Подробная информация о каждом пункте выдачи
    Управление приемками
- Создание сессий приемки товаров
  - Закрытие сессий приемки 
  - Отслеживание статусов приемки (in_progress, closed)
    Управление товарами
- Добавление товаров в текущую приемку 
  - Удаление товаров (по принципу LIFO)
  - Категоризация товаров (электроника, одежда, обувь)
    Отчетность и фильтрация
- Фильтрация данных по диапазонам дат 
  - Поддержка пагинации 
  - Комплексное получение данных

## Архитектура системы
API следует дизайну чистой архитектуры со следующими слоями:
- **Слой API**: HTTP-обработчики и промежуточное ПО
- **Сервисный слой**: Реализация бизнес-логики 
- **Слой репозитория**: Взаимодействие с базой данных
- `Слой сущностей`: Доменные модели

Приложение использует PostgreSQL для хранения данных и включает сбор метрик через Prometheus

## Документация API
Документация API доступна через Swagger UI по адресу `/swagger/` при запущенном сервере

Ключевые конечные точки включают:
- **Конечные точки аутентификации**
  - `/api/v1/dummyLogin` - Получить тестовый токен 
  - `/api/v1/login` - Аутентифицировать пользователя 
  - `/api/v1/register` - Зарегистрировать нового пользователя
- **Конечные точки ПВЗЖ**:
  - `/api/v1/pvz` (**GET**) - Список пунктов выдачи с деталями 
  - `/api/v1/pvz `(**POST**) - Создать новый пункт выдачи 
  - `/api/v1/pvz/{pvzId}/delete_last_product` - Удалить последний добавленный товар 
  - `/api/v1/pvz/{pvzId}/close_last_reception` - Закрыть последнюю приемку
- **Конечные точки приемки**
  - `/api/v1/receptions` - Создать новую приемку 
- **Конечные точки товаров**
  - `/api/v1/products` - Добавить товар в открытую приемку

## Аутентификация
API использует JWT-токены для аутентификации. Токены можно получить через:
- `/api/v1/dummyLogin` - Для целей разработки/тестирования 
- `/api/v1/login` - Обычная аутентификация по электронной почте/паролю 
- `/api/v1/register` - Регистрация нового пользователя
Токены должны быть включены в заголовок `Authorization` как `Bearer {token}` для защищенных конечных точек.

## Конфигурация
Конфигурация приложения разделена между файлами `.env` и `config/config.yaml`
- `env`: Хранит переменные окружения, специфичные для окружения (local, dev, prod), и чувствительные данные.
- `config/config.yaml`: Хранит статические настройки приложения, такие как таймауты, лимиты подключений и параметры Prometheus

## Метрики и мониторинг
API включает метрики Prometheus для мониторинга:
- Количество HTTP-запросов 
- Продолжительность HTTP-запросов
- Количество созданных ПВЗ
- Количество созданных приёмок заказов
- Количество добавленных товаров

- Метрики выводятся через промежуточное ПО Prometheus и могут быть просмотрены с помощью пользовательского интерфейса Prometheus.


## Тестирование
В проекте используется комплексный подход к тестированию, который включает модульные (unit) тесты и интеграционные тесты.

### Расчёт покрытия кода тестами
```bash
go test ./... -coverprofile=coverage.out -coverpkg=$(go list ./... | grep -v "/mocks/" | tr '\n' ',')
```
Мок-файлы не должны учитываться при подсчёте покрытия: Файлы в директориях internal/repo/mocks и internal/service/mocks автоматически генерируются инструментами типа mockery для эмуляции интерфейсов в тестах
### Просмотр итогового покрытия
```bash
go tool cover -func=coverage.out
```
Покрытие тестами `81.7%`